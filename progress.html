<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Transcription Progress</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='styles.css') }}" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Transcription Progress</h1>
        <div class="progress-container">
            <div class="progress">
                <div id="progressBar" class="progress-bar progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
            </div>
            <p id="status">Initializing...</p>
        </div>
        <div id="download-link" class="mt-4"></div>
        <div id="home-button" class="mt-3 text-center" style="display: none;">
            <a href="/" class="btn btn-secondary"><i class="fas fa-home"></i> Back to Home</a>
        </div>
    </div>
    <script>
    var socket = io();
    var progressBar = document.getElementById('progressBar');
    var statusElement = document.getElementById('status');
    var downloadLinkElement = document.getElementById('download-link');
    var homeButtonElement = document.getElementById('home-button');
    var fileProgress = {};
    var totalFiles = 0;
    var overallProgress = 0;

    socket.on('connect', function() {
        console.log('Connected to server');
    });

    socket.on('update_progress', function(data) {
        console.log('Received progress update:', data);
        if (data.file === 'all') {
            overallProgress = data.progress;
        } else {
            fileProgress[data.file] = data.progress;
        }
        updateProgressBar();
        statusElement.textContent = data.status;
    });

    socket.on('transcription_complete', function(data) {
        console.log('Transcription complete:', data);
        statusElement.textContent = 'Transcription complete!';
        downloadLinkElement.innerHTML = '<a href="' + data.download_url + '" class="btn btn-primary"><i class="fas fa-download"></i> Download Transcription</a>';
        homeButtonElement.style.display = 'block';
        overallProgress = 100;
        updateProgressBar();
    });

    socket.on('error', function(data) {
        console.error('Error:', data.message);
        statusElement.textContent = 'Error: ' + data.message;
        homeButtonElement.style.display = 'block';
    });

    socket.on('all_files_complete', function() {
        console.log('All files processed');
        statusElement.textContent = 'All files processed, preparing download...';
        overallProgress = 100;
        updateProgressBar();
    });

    function updateProgressBar() {
        var progress;
        if (overallProgress > 0) {
            progress = overallProgress;
        } else {
            var totalProgress = Object.values(fileProgress).reduce((a, b) => a + b, 0);
            progress = Math.min(95, Math.round(totalProgress / totalFiles));
        }
        progressBar.style.width = progress + '%';
        progressBar.setAttribute('aria-valuenow', progress);
        progressBar.textContent = progress + '%';

        // Add or remove the animated class based on progress
        if (progress < 100) {
            progressBar.classList.add('progress-bar-animated');
        } else {
            progressBar.classList.remove('progress-bar-animated');
        }
    }

    socket.emit('get_total_files');
    socket.on('set_total_files', function(data) {
        totalFiles = data.total_files;
        for (var i = 1; i <= totalFiles; i++) {
            fileProgress[i] = 0;
        }
    });

    // Initialize the progress bar with the animated class
    progressBar.classList.add('progress-bar-animated');
    </script>
</body>
</html>